<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PedidoController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sfmaranatha</a> &gt; <a href="index.source.html" class="el_package">com.maranatha.sfmaranatha.Controllers</a> &gt; <span class="el_source">PedidoController.java</span></div><h1>PedidoController.java</h1><pre class="source lang-java linenums">package com.maranatha.sfmaranatha.Controllers;

import com.maranatha.sfmaranatha.Model.Pedido;
import com.maranatha.sfmaranatha.Model.Usuario;
import com.maranatha.sfmaranatha.Repository.PedidoRepository;
import com.maranatha.sfmaranatha.Service.PedidoService;
import com.maranatha.sfmaranatha.Service.UsuarioService;
import com.maranatha.sfmaranatha.dto.PedidoRequestDTO;
import com.maranatha.sfmaranatha.dto.PedidoDetalladoDTO;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/pedidos&quot;)
@Tag(name = &quot;Pedidos&quot;, description = &quot;Yo me encargo de todo lo relacionado con los pedidos de los clientes.&quot;)
<span class="nc" id="L26">public class PedidoController {</span>

    @Autowired
    private PedidoRepository miRepositorioDePedidos;

    @Autowired
    private PedidoService miServicioDePedidos;

    @Autowired
    private UsuarioService miServicioDeUsuarios;

    /**
     * Creo un nuevo pedido usando el DTO moderno PedidoRequestDTO.
     */
    @PostMapping(&quot;/nuevo&quot;)
    @Operation(summary = &quot;Crear un nuevo pedido con DTO&quot;,
               description = &quot;Yo recibo un PedidoRequestDTO y creo un nuevo pedido en el sistema.&quot;)
    public ResponseEntity&lt;?&gt; crearPedidoConDTO(@RequestBody PedidoRequestDTO datosDelPedido) {
        try {
<span class="nc" id="L45">            Pedido pedidoCreado = miServicioDePedidos.crearPedido(datosDelPedido);</span>
<span class="nc" id="L46">            return ResponseEntity.ok(Map.of(</span>
<span class="nc" id="L47">                &quot;exito&quot;, true,</span>
                &quot;mensaje&quot;, &quot;¡Tu pedido ha sido guardado correctamente!&quot;,
<span class="nc" id="L49">                &quot;pedidoId&quot;, pedidoCreado.getIdPedido(),</span>
<span class="nc" id="L50">                &quot;total&quot;, pedidoCreado.getTotal()</span>
            ));
<span class="nc" id="L52">        } catch (SecurityException se) {</span>
<span class="nc" id="L53">            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, se.getMessage()));</span>
<span class="nc" id="L54">        } catch (RuntimeException e) {</span>
<span class="nc" id="L55">            return ResponseEntity.badRequest().body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Error al guardar el pedido: &quot; + e.getMessage()));</span>
<span class="nc" id="L56">        } catch (Exception e) {</span>
<span class="nc" id="L57">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Ocurrió un error inesperado procesando tu pedido.&quot;));</span>
        }
    }

    /**
     * Consulto todos los pedidos del sistema con información detallada.
     */
    @GetMapping
    @Operation(summary = &quot;Consultar todos los pedidos (Admin)&quot;,
               description = &quot;Yo devuelvo todos los pedidos con información detallada, o los filtro por estado si se especifica.&quot;)
    public ResponseEntity&lt;?&gt; consultarTodosLosPedidos(@RequestParam(required = false) String estado) {
        try {
            List&lt;Pedido&gt; pedidos;
<span class="nc bnc" id="L70" title="All 4 branches missed.">            if (estado != null &amp;&amp; !estado.isEmpty()) {</span>
<span class="nc" id="L71">                pedidos = miRepositorioDePedidos.findByEstado(estado.toUpperCase());</span>
            } else {
<span class="nc" id="L73">                pedidos = miRepositorioDePedidos.findAll();</span>
            }
            
            // Convierto a DTO detallado para incluir información de items
<span class="nc" id="L77">            List&lt;PedidoDetalladoDTO&gt; pedidosDetallados = pedidos.stream()</span>
<span class="nc" id="L78">                .map(miServicioDePedidos::convertirAPedidoDetallado)</span>
<span class="nc" id="L79">                .collect(Collectors.toList());</span>
            
<span class="nc" id="L81">            return ResponseEntity.ok(pedidosDetallados);</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            return ResponseEntity.badRequest().body(Map.of(</span>
<span class="nc" id="L84">                &quot;exito&quot;, false,</span>
<span class="nc" id="L85">                &quot;mensaje&quot;, &quot;Error al consultar los pedidos: &quot; + e.getMessage()</span>
            ));
        }
    }

    /**
     * Actualizo el estado de un pedido.
     */
    @PutMapping(&quot;/actualizar-estado/{id}&quot;)
    @Operation(summary = &quot;Actualizar estado de pedido&quot;,
               description = &quot;Yo actualizo el estado de un pedido (PENDIENTE -&gt; ENTREGADO o CANCELADO).&quot;)
    public ResponseEntity&lt;?&gt; actualizarEstadoPedido(
            @PathVariable Long id, 
            @RequestParam String nuevoEstado,
            java.security.Principal principal) {
        
<span class="nc bnc" id="L101" title="All 4 branches missed.">        if (principal == null || principal.getName() == null) {</span>
<span class="nc" id="L102">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L103">                .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;No estás autenticado para realizar esta acción.&quot;));</span>
        }

        try {
<span class="nc" id="L107">            Optional&lt;Usuario&gt; usuarioOpt = miServicioDeUsuarios.buscarPorCorreo(principal.getName());</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (usuarioOpt.isEmpty()) {</span>
<span class="nc" id="L109">                return ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="nc" id="L110">                    .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Usuario autenticado no encontrado en el sistema.&quot;));</span>
            }
            
<span class="nc" id="L113">            Usuario usuarioAutenticado = usuarioOpt.get();</span>
            
            // Verifico que sea ADMIN o ENCARGADO
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (!usuarioAutenticado.getTipoUsuario().equals(&quot;ADMIN&quot;) &amp;&amp; </span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                !usuarioAutenticado.getTipoUsuario().equals(&quot;ENCARGADO&quot;)) {</span>
<span class="nc" id="L118">                return ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="nc" id="L119">                    .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;No tienes permisos para actualizar estados de pedidos.&quot;));</span>
            }

<span class="nc" id="L122">            Pedido pedidoActualizado = miServicioDePedidos.actualizarEstadoPedido(id, nuevoEstado);</span>
            
<span class="nc" id="L124">            return ResponseEntity.ok(Map.of(</span>
<span class="nc" id="L125">                &quot;exito&quot;, true,</span>
                &quot;mensaje&quot;, &quot;Estado del pedido actualizado correctamente.&quot;,
<span class="nc" id="L127">                &quot;pedidoId&quot;, pedidoActualizado.getIdPedido(),</span>
<span class="nc" id="L128">                &quot;nuevoEstado&quot;, pedidoActualizado.getEstado()</span>
            ));
<span class="nc" id="L130">        } catch (Exception e) {</span>
<span class="nc" id="L131">            return ResponseEntity.badRequest().body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, e.getMessage()));</span>
        }
    }

    /**
     * Devuelvo todos los pedidos que ha realizado el usuario que está actualmente autenticado.
     */
    @GetMapping(&quot;/mis-pedidos&quot;)
    @Operation(summary = &quot;Consultar mis pedidos (Cliente)&quot;,
               description = &quot;Yo devuelvo una lista de todos tus pedidos, opcionalmente filtrados por estado.&quot;)
    public ResponseEntity&lt;?&gt; obtenerMisPedidos(
            @RequestParam(required = false) String estado,
            java.security.Principal principal) {
        
<span class="nc bnc" id="L145" title="All 4 branches missed.">        if (principal == null || principal.getName() == null) {</span>
<span class="nc" id="L146">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L147">                .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Debes iniciar sesión para ver tus pedidos.&quot;));</span>
        }

        try {
<span class="nc" id="L151">            Optional&lt;Usuario&gt; usuarioOpt = miServicioDeUsuarios.buscarPorCorreo(principal.getName());</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (usuarioOpt.isEmpty()) {</span>
<span class="nc" id="L153">                return ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="nc" id="L154">                    .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Usuario autenticado no encontrado en el sistema.&quot;));</span>
            }
<span class="nc" id="L156">            Usuario usuarioActual = usuarioOpt.get();</span>

            List&lt;Pedido&gt; pedidosDelUsuario;
<span class="nc bnc" id="L159" title="All 4 branches missed.">            if (estado != null &amp;&amp; !estado.isEmpty()) {</span>
<span class="nc" id="L160">                pedidosDelUsuario = miRepositorioDePedidos.findByUsuarioAndEstado(usuarioActual, estado.toUpperCase());</span>
            } else {
<span class="nc" id="L162">                pedidosDelUsuario = miRepositorioDePedidos.findByUsuario(usuarioActual);</span>
            }
            
<span class="nc" id="L165">            return ResponseEntity.ok(pedidosDelUsuario);</span>

<span class="nc" id="L167">        } catch (Exception e) {</span>
<span class="nc" id="L168">            return ResponseEntity.badRequest().body(Map.of(</span>
<span class="nc" id="L169">                &quot;exito&quot;, false,</span>
<span class="nc" id="L170">                &quot;mensaje&quot;, &quot;Tuve un error al consultar tus pedidos: &quot; + e.getMessage()</span>
            ));
        }
    }

    /**
     * Me encargo de cancelar un pedido si me dan su ID.
     */
    @PutMapping(&quot;/cancelar/{id}&quot;)
    @Operation(summary = &quot;Cancelar un pedido existente&quot;,
               description = &quot;Yo cambio el estado de un pedido a 'CANCELADO'. Verifico que esté 'PENDIENTE' y que quien lo pide sea el dueño o un admin/encargado.&quot;)
    public ResponseEntity&lt;?&gt; cancelarPedido(@PathVariable Long id, java.security.Principal principal) {
<span class="nc bnc" id="L182" title="All 4 branches missed.">        if (principal == null || principal.getName() == null) {</span>
<span class="nc" id="L183">            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L184">                .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;No estás autenticado para realizar esta acción.&quot;));</span>
        }

        try {
<span class="nc" id="L188">            Optional&lt;Usuario&gt; usuarioOpt = miServicioDeUsuarios.buscarPorCorreo(principal.getName());</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (usuarioOpt.isEmpty()) {</span>
<span class="nc" id="L190">                return ResponseEntity.status(HttpStatus.FORBIDDEN)</span>
<span class="nc" id="L191">                    .body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, &quot;Usuario autenticado no encontrado en el sistema.&quot;));</span>
            }
<span class="nc" id="L193">            Usuario usuarioAutenticado = usuarioOpt.get();</span>

<span class="nc" id="L195">            Pedido pedidoCancelado = miServicioDePedidos.cancelarPedido(id, usuarioAutenticado.getIdUsuario(), usuarioAutenticado.getTipoUsuario());</span>
            
<span class="nc" id="L197">            return ResponseEntity.ok(Map.of(</span>
<span class="nc" id="L198">                &quot;exito&quot;, true,</span>
                &quot;mensaje&quot;, &quot;¡Pedido cancelado con éxito!&quot;,
<span class="nc" id="L200">                &quot;pedidoId&quot;, pedidoCancelado.getIdPedido()</span>
            ));
<span class="nc" id="L202">        } catch (SecurityException se) {</span>
<span class="nc" id="L203">            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, se.getMessage()));</span>
        }
<span class="nc" id="L205">        catch (Exception e) {</span>
<span class="nc" id="L206">            return ResponseEntity.badRequest().body(Map.of(&quot;exito&quot;, false, &quot;mensaje&quot;, e.getMessage()));</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>